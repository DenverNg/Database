-- MSSV: 22127085
-- Họ Tên: Nguyễn Hồ Đăng Duy
-- Lớp: 22CLC09
-- Hàng: 3
-- Cột: 5
-- Mã đề: 3
USE MASTER
GO
IF DB_ID('QLTOUR') IS NOT NULL
    DROP DATABASE QLTOUR
GO

CREATE DATABASE QLTOUR
GO

USE QLTOUR
GO

CREATE TABLE TOUR
(
    MATOUR     CHAR(5),
    TENTOUR    NVARCHAR(100),
    TRUONGDOAN CHAR(5),
    SOKHACH    INT,
    LOAIND     CHAR(5),
    DONGIA     INT

        CONSTRAINT PK_TOUR
    PRIMARY KEY(MATOUR)
)

CREATE TABLE NGUOIDUNG
(
    MAND     CHAR(5),
    HOTEN    NVARCHAR(50),
    LOAIND   CHAR(5),
    NGAYSINH DATE,
    DIACHI   NVARCHAR(50)

        CONSTRAINT PK_NGUOIDUNG
    PRIMARY KEY(MAND, LOAIND)
)

CREATE TABLE DATTOUR
(
    MAKH    CHAR(5),
    MATOUR  CHAR(5),
    LOAIND  CHAR(5),
    NGAYDI  DATE,
    NGAYMUA DATE,
    DONGIA  INT

        CONSTRAINT PK_DATTOUR
    PRIMARY KEY(MAKH, MATOUR, LOAIND,NGAYDI)
)

ALTER TABLE TOUR
ADD    
    CONSTRAINT FK_TOUR_NGUOIDUNG
    FOREIGN KEY(TRUONGDOAN, LOAIND)
    REFERENCES NGUOIDUNG(MAND, LOAIND)

ALTER TABLE DATTOUR 
ADD 
    CONSTRAINT FK_DATTOUR_NGUOIDUNG
    FOREIGN KEY(MAKH, LOAIND)
    REFERENCES NGUOIDUNG(MAND, LOAIND),

    CONSTRAINT FK_DATTOUR_TOUR
    FOREIGN KEY(MATOUR)
    REFERENCES TOUR(MATOUR)

INSERT NGUOIDUNG
    (MAND, HOTEN, NGAYSINH, DIACHI, LOAIND)
VALUES
    ('0001', N'Nguyễn Thị Minh', '02/12/2000', N'123 Vườn Lài, Quận Tân Phú', 'NV'),
    ('0002', N'Trần Trung Nghĩa', '11/23/2009', N'45 Phú Thọ Hòa, Quận Tân Phú', 'NV'),
    ('0001', N'Vũ Ánh Nguyệt', '11/22/1997', N'11 Võ Văn Ngân, Quận Thủ Đức', 'KH'),
    ('0002', N'Trần Thu Phương', '11/11/2007', N'11 Nguyễn Trãi, Quận 5', 'KH'),
    ('0005', N'Nguyễn Minh Hùng', '01/10/2000', NULL, 'KH')

INSERT TOUR
    (MATOUR, TENTOUR, TRUONGDOAN, SOKHACH, LOAIND, DONGIA)
VALUES
    ('SP001', N'Tour Đà Nẵng - Huế - Hội An', '0001', 120, 'NV', 3500000),
    ('SP002', N'Tour Nha Trang', '0002', 50, 'NV', 1500000),
    ('SP004', N'Tour Đà Lạt - Thành phố ngàn hoa', '0001', 35, 'NV', 2500000),
    ('SP003', N'Tour Sapa - Khám phá chữ "Tình" của vùng núi Tây Bắc', NULL, 35, NULL, 3450000)

INSERT DATTOUR
    (MAKH, MATOUR, LOAIND, NGAYMUA, NGAYDI, DONGIA)
VALUES
    ('0001', 'SP001', 'KH', '02/12/2019', '04/12/2019', 3500000),
    ('0001', 'SP002', 'KH', '02/12/2019', '03/17/2019', 1500000),
    ('0005', 'SP001', 'KH', '06/06/2021', '10/12/2021', 3500000),
    ('0005', 'SP001', 'KH', '03/07/2022', '08/22/2022', 3500000),
    ('0002', 'SP002', 'KH', '03/07/2022', '07/17/2022', 1500000),
    ('0001', 'SP003', 'KH', '03/07/2022', '07/17/2022', 3450000)

--4. Cho biết thông tin tour do trưởng đoàn ở Tân Phú và trên 20 tuổi dẫn đoàn
SELECT T.*
FROM TOUR T JOIN NGUOIDUNG ND ON (T.TRUONGDOAN= ND.MAND AND T.LOAIND = ND.LOAIND)
WHERE ND.DIACHI LIKE N'% Tân Phú' AND DATEDIFF(YEAR, ND.NGAYSINH, GETDATE()) > 20

--5. Cho biết thông tin khách hàng, số lượng tour đã đặt trong tháng 2/2019
SELECT ND.*, COUNT(DT.MAKH) AS 'SOLUONGTOUR'
FROM NGUOIDUNG ND JOIN DATTOUR DT ON (ND.MAND = DT.MAKH AND ND.LOAIND = DT.LOAIND)
WHERE MONTH(DT.NGAYMUA) = 2 AND YEAR(DT.NGAYMUA) = 2019
GROUP BY ND.MAND, ND.HOTEN, ND.NGAYSINH, ND.DIACHI, ND.LOAIND
